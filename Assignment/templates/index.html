<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Room Booking System</title>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

    <header>
        <h1>RedRoom Booking</h1>
        {% if page == 'dashboard' %}
            <div class="user-info">
                <span>Welcome, {{ user.first }} ({{ user.role }})</span>
                <a href="/logout" class="btn btn-outline">Logout</a>
            </div>
        {% endif %}
    </header>

    <main>
        {% if page == 'login' %}
        <div class="auth-container">
            <div class="card">
                <h2>Login</h2>
                <form action="/login" method="POST">
                    <label>Select User (Demo Mode):</label>
                    <select name="email" required>
                        <option value="" disabled selected>Select a user...</option>
                        {% for u in users %}
                            <option value="{{ u.email }}">{{ u.first }} {{ u.last }} ({{ u.role }})</option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="btn">Login</button>
                </form>
            </div>

            <div class="card">
                <h2>Create Account</h2>
                <form action="/register" method="POST">
                    <input type="text" name="first" placeholder="First Name" required>
                    <input type="text" name="last" placeholder="Last Name" required>
                    <input type="email" name="email" placeholder="Email (@ required)" required>
                    <button type="submit" class="btn">Register</button>
                </form>
            </div>
        </div>

        {% elif page == 'dashboard' %}
        <div class="dashboard-container">
            
            <div class="sidebar">
                <h3>Book a Room</h3>
                <div id="status-msg"></div>
                <form id="bookingForm">
                    <label>Room</label>
                    <select id="roomId" required>
                        {% for r in rooms %}
                            <option value="{{ r.id }}">{{ r.name }}</option>
                        {% endfor %}
                    </select>
                    
                    <label>Date</label>
                    <input type="date" id="bookingDate" required>
                    
                    <div class="time-group">
                        <div>
                            <label>Start Time</label>
                            <select id="startTime" required></select>
                        </div>
                        <div>
                            <label>End Time</label>
                            <select id="endTime" required></select>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn">Book Now</button>
                </form>
                <div class="instructions">
                    <p><strong>Instructions:</strong></p>
                    <ul>
                        <li>Select <strong>Date</strong>.</li>
                        <li>Choose <strong>Start</strong> & <strong>End</strong> (30-min intervals).</li>
                        <li>Or <strong>Click & Drag</strong> on the Calendar.</li>
                        <li>Max 8 hours. No overlaps.</li>
                    </ul>
                </div>

                <hr style="margin: 2rem 0; border: 0; border-top: 1px solid #ccc;">

                <h3>Room Reports</h3>
                <div class="room-list-nav">
                    {% for r in rooms %}
                        <a href="/rooms/{{ r.id }}/list" class="room-link">
                            ðŸ“„ List {{ r.name }} Bookings
                        </a>
                    {% endfor %}
                </div>
            </div>

            <div class="calendar-wrapper">
                <div id='calendar'></div>
            </div>
        </div>

        <script>
            // --- 1. Populate Time Dropdowns (00:00 to 23:30) ---
            function populateTimeSelects() {
                const startSel = document.getElementById('startTime');
                const endSel = document.getElementById('endTime');
                
                const times = [];
                for(let h=0; h<24; h++) {
                    for(let m=0; m<60; m+=30) {
                        const hourStr = h.toString().padStart(2, '0');
                        const minStr = m.toString().padStart(2, '0');
                        times.push(`${hourStr}:${minStr}`);
                    }
                }

                // Helper to add options
                const addOptions = (select, vals) => {
                    select.innerHTML = "";
                    vals.forEach(t => {
                        const opt = document.createElement('option');
                        opt.value = t;
                        opt.textContent = t;
                        select.appendChild(opt);
                    });
                };

                addOptions(startSel, times);
                addOptions(endSel, times);
                
                // Set default defaults (e.g., 09:00 to 10:00)
                startSel.value = "09:00";
                endSel.value = "10:00";
            }

            // --- 2. Helper to Format Date Objects to "HH:MM" ---
            function formatTimePart(dateObj) {
                const h = dateObj.getHours().toString().padStart(2, '0');
                const m = dateObj.getMinutes().toString().padStart(2, '0');
                return `${h}:${m}`;
            }
            
            // --- 3. Helper to Format Date Objects to "YYYY-MM-DD" ---
            function formatDatePart(dateObj) {
                const year = dateObj.getFullYear();
                const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                const day = dateObj.getDate().toString().padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            document.addEventListener('DOMContentLoaded', function() {
                populateTimeSelects();

                // Set default date to today
                document.getElementById('bookingDate').valueAsDate = new Date();

                var calendarEl = document.getElementById('calendar');
                var calendar = new FullCalendar.Calendar(calendarEl, {
                    // 1. VIEWS: Year (default), Month, Week
                    initialView: 'multiMonthYear', 
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'multiMonthYear,dayGridMonth,timeGridWeek'
                    },
                    
                    // 2. 24-HOUR FORMAT
                    slotLabelFormat: {
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    },
                    eventTimeFormat: {
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    },

                    // General Settings
                    slotMinTime: "07:00:00",
                    slotMaxTime: "22:00:00",
                    nowIndicator: true,
                    events: '/api/bookings',
                    
                    // 3. SELECTABLE (Click to Book)
                    selectable: true,
                    selectMirror: true,
                    snapDuration: '00:30', // Enforces 30 min selection
                    
                    select: function(info) {
                        // When user selects a time range on calendar:
                        // 1. Set the Date input
                        document.getElementById('bookingDate').value = formatDatePart(info.start);
                        
                        // 2. Set Start/End Time selects
                        // Note: In Year/Month view, info.start usually has 00:00 time.
                        // In Week view, it has specific time.
                        
                        if (info.view.type === 'timeGridWeek' || info.view.type === 'timeGridDay') {
                            const sTime = formatTimePart(info.start);
                            const eTime = formatTimePart(info.end);
                            
                            document.getElementById('startTime').value = sTime;
                            document.getElementById('endTime').value = eTime;
                        } else {
                            // If clicked in Year/Month view, just keep default times (09:00-10:00) 
                            // but update the date (already done above).
                        }

                        // Scroll sidebar into view on mobile if needed
                        document.querySelector('.sidebar').scrollIntoView({ behavior: 'smooth' });
                    },

                    eventClick: function(info) {
                        if (info.event.extendedProps.can_delete) {
                            if(confirm("Do you want to cancel this booking?")) {
                                fetch(`/api/bookings/${info.event.id}`, { method: 'DELETE' })
                                .then(res => res.json())
                                .then(data => {
                                    if(data.error) alert(data.error);
                                    else {
                                        info.event.remove();
                                        alert("Booking cancelled.");
                                    }
                                });
                            }
                        } else {
                            alert("You cannot modify other users' bookings.");
                        }
                    }
                });
                calendar.render();

                // Handle Booking Form
                document.getElementById('bookingForm').addEventListener('submit', function(e) {
                    e.preventDefault();
                    const statusDiv = document.getElementById('status-msg');
                    
                    const dateVal = document.getElementById('bookingDate').value;
                    const startVal = document.getElementById('startTime').value;
                    const endVal = document.getElementById('endTime').value;
                    const roomId = document.getElementById('roomId').value;

                    // Combine Date + Time into ISO Strings
                    // App expects ISO format, e.g., 2023-10-25T14:30:00
                    const startISO = `${dateVal}T${startVal}:00`;
                    const endISO = `${dateVal}T${endVal}:00`;

                    fetch('/api/bookings', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            roomId: roomId,
                            start: startISO,
                            end: endISO
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if(data.error) {
                            statusDiv.innerHTML = `<span class="error">${data.error}</span>`;
                        } else {
                            statusDiv.innerHTML = `<span class="success">Booking Successful!</span>`;
                            calendar.refetchEvents();
                        }
                    });
                });
            });
        </script>
        {% endif %}
    </main>
</body>
</html>